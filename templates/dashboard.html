{% extends 'base.html' %}
{% load static %}
{% block custom_styles %}
    <link rel="stylesheet" href="{% static 'styles/dashboard.css' %}">
    <link rel="stylesheet" href="{% static 'styles/gauges.css' %}">
{% endblock %}
{% block content %}
    <div class="container">
        <h1>Dashboard de Medici√≥n</h1>
        <table>
            <thead>
            <tr>
                <th>Fecha y Hora</th>
                <th>üå°Ô∏è Temperatura (¬∞C)</th>
                <th>üß™ pH</th>
                <th>üíß TDS (ppm)</th>
            </tr>
            </thead>
            <tbody>
            {% for m in measurements %}
                <tr>
                    <td>{{ m.timestamp|date:"Y-m-d H:i:s" }}</td>
                    <td>{{ m.temperature }}</td>
                    <td>{{ m.ph }}</td>
                    <td>{{ m.tds }}</td>
                </tr>
            {% empty %}
                <tr>
                    <td colspan="4">No hay datos disponibles</td>
                </tr>
            {% endfor %}
            </tbody>
        </table>
        <div class="gauge-container row text-center">
            <h2>Mediciones Actuales</h2>
            
            <!-- Gauge de Temperatura -->
            <div class="col-md-4">
                <h3>Temperatura</h3>
                <div id="temperature-gauge">
                    <svg width="300" height="150"></svg>
                </div>
            </div>
        
            <!-- Gauge de S√≥lidos Disueltos -->
            <div class="col-md-4">
                <h3>S√≥lidos Disueltos</h3>
                <div id="tds-gauge">
                    <svg width="300" height="150"></svg>
                </div>
            </div>
        
            <!-- Gauge de pH -->
            <div class="col-md-4">
                <h3>pH</h3>
                <div id="ph-gauge">
                    <svg width="300" height="150"></svg>
                </div>
            </div>
        </div>`                
    </div>
{% endblock %}
{% block custom_scripts %}
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script>
        const currentTemp = {{ last_temp|default:"null" }};
        const currentTDS = {{ last_tds|default:"null" }};
        const currentPH = {{ last_ph|default:"null" }};
    </script>
    <script src="{% static 'scripts/gauges.js' %}"></script>
    <script>
        const updateTemp = createGauge("#temperature-gauge", -55, 125, "temperatureGradient", currentTemp, "¬∞C");
        const updateTDS = createGauge("#tds-gauge", 0, 1000, "tdsGradient", currentTDS, " ppm");
        const updatePH = createGauge("#ph-gauge", 0, 14, "phGradient", currentPH, "");
    
        function fetchAndUpdateGauges() {
            fetch('/sensors/latest/')
                .then(response => response.json())
                .then(data => {
                    if (data.temperature !== null) updateTemp(data.temperature);
                    if (data.tds !== null) updateTDS(data.tds);
                    if (data.ph !== null) updatePH(data.ph);
                })
                .catch(error => console.error("Error al obtener datos:", error));
        }
    
        setInterval(fetchAndUpdateGauges, 2000);
        fetchAndUpdateGauges(); // Llamada inicial
    </script>    
{% endblock %}